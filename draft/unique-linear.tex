\documentclass{llncs}

\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage[utf8]{inputenc}
\usepackage{mathpartir}

\input{macros}

\begin{document}
Syntax
\begin{align*}
  e &::= x \mid \LAM xe \mid \APP ee \mid \LET xee \mid \REC{ \overline{a=e}} \mid \GET ea \mid \UPD eae \\
  \ell &::= \LIN \mid \UN & \UN & \sqsubset \LIN \\
  u &::= \READ \mid \WRITE & \WRITE & \sqsubset \READ \\
  t &::= b\,\ell\, u \\
  b &::= t \to t \mid \REC{ \overline{a : t}}
\end{align*}
Every type has two attributes, linearity $\ell$ and uniqueness $u$.

An environment $A$ is a partial mapping from variables to types. Environment overriding $A=A'\OVERRIDE A''$ is defined as the pointwise extension of a ternary relation on types. We write $x:t\,-$ to indicate that no binding for $x$ exists. 
\begin{mathpar}
  \inferrule{}{b\,\UN\,\READ  =  b\,\UN\,\READ   \OVERRIDE' b\,\UN\,\READ}

  \inferrule{}{b\,\UN\,\WRITE  =  b\,\UN\,\WRITE  \OVERRIDE b\,-}
  \\
  \inferrule{b = b' \OVERRIDE' b''}
  {b\,\UN\,\WRITE  =  b'\,\UN\,\READ   \OVERRIDE' b''\, \UN\,\WRITE}

  \inferrule{t = t' \OVERRIDE' t''}{t = t' \OVERRIDE t''}
  \\
  \inferrule{}{t\,\LIN\,u           =  t\,\LIN\,u           \OVERRIDE t\,-}

  \inferrule{}{t\,\LIN\,u           =  t\,-                     \OVERRIDE t\, \LIN\,u}
  \\
  \inferrule{
    t_i = t_i' \OVERRIDE' t_i''
  }{
    \REC{ a_1:t_1, \dots } =     \REC{ a_1:t_1', \dots } \OVERRIDE'     \REC{ a_1:t_1'', \dots }
  }

  \inferrule{}{t_1\to t_2 = t_1 \to t_2 \OVERRIDE' t_1 \to t_2}
\end{mathpar}
For $n>2$ define $A= A_1 \OVERRIDE A_2 \OVERRIDE \dots \OVERRIDE A_n$ by $A= A_1 \OVERRIDE A_1'$ and $A_1' = A_2 \OVERRIDE \dots \OVERRIDE A_n$. 

\newpage
If any record component is linear, then the record must be linear, too.
If any of the components has write premission, then the record must have it, too.
\begin{mathpar}
  \inferrule{
    A = A_1 \OVERRIDE \dots \OVERRIDE A_n \\
    A_i \vdash e_i : t_i\,\ell_i\,u_i \\
    \ell_i \sqsubseteq \ell \\
    u \sqsubseteq u_i
  }{
    A \vdash \REC{ \overline{a_i=e_i}} : \REC{ \overline{a_i : t_i}}\,\ell\, u
  }
\end{mathpar}
Reading from a record is a use of the record: If the record is linear, then there can be only one use. The fields that are dropped  must not be linear. Thus, a linear record can have at most a single linear field and no other field can be accessed. (That seems overly restrictive, but could be amended by a record elimination that reads more than one field at a time.) 

Uniqueness of the record does not matter for reading. The attributes of the field's type remain as they are, if the record has write permission. (If the record has only read permission, then none of the fields can have write permission, so the attributes remain the same, too.)
\begin{mathpar}
  \inferrule{
    A \vdash e : \REC{ a:t \mid r}\,\ell\,u \\
    \UN (r)
  }{
    A \vdash \GET ea : t
  }
\end{mathpar}
To write to a record, we need write permission. The type of the overwritten field must be unrestricted because the old contents is dropped. (It would be good to have an update operation that works on linear fields.)
\begin{mathpar}
  \inferrule{
    A_0 \vdash e_0 : \REC{ a:t \mid r}\,\ell\,\WRITE \\
    A_1 \vdash e_1 : t \\
    \UN (t) \\
    A = A_0 \OVERRIDE A_1
  }{
    A \vdash \UPD {e_0}a{e_1} : \REC{ a:t \mid r}\,\ell\,u
  }
\end{mathpar}

\begin{mathpar}
  \inferrule{
  }{
    A, x: t \vdash x:t
  }
\end{mathpar}
Uniqueness does not matter for a function. However, a function that captures a linear variable or a variable with write permission must be linear. A function that captures a record with read permission can be influenced by subsequent writes to that record. Thus the following combinations are possible.
\begin{itemize}
\item $y:t \in A$ is readonly, which means that no future writes through $y$ are possible. Readonly variables impose no restriction on the function type, but currently we have no notion of readonly.
\item $y:t \in A$ needs write permission to typecheck $e$. This requires $\ell = \LIN$, so that writes are only executed at  most once. If $\ell \ne\LIN$, then $y$ needs to be copied each time the closure is invoked.
\item $y:t \in A$ is linear requires that $\ell = \LIN$, so that the linear stuff is used exactly once.
\end{itemize}
\begin{mathpar}
  \inferrule{
    A, x:t' \vdash e : t
  }{
    A \vdash \LAM x e : (t' \to t)\,\ell\,u
  }
\end{mathpar}
Function application has no particular restrictions, it seems.
\begin{mathpar}
  \inferrule{
    A_0 \vdash e_0 : (t_1 \to t_2)\, \ell\,u \\
    A_1 \vdash e_1 : t_1 \\
    A = A_0 \OVERRIDE A_1
  }{
    A \vdash \APP{e_0}e_1 : t_2
  }
\end{mathpar}
\end{document}
